<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Maidenlane/YCabal Software Design and Specification</title>
<style>
@import url(//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.0/css/font-awesome.css);
/* normalize.css v2.1.1 | MIT License | git.io/normalize */
/* ========================================================================== HTML5 display definitions ========================================================================== */
/** Correct `block` display not defined in IE 8/9. */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }

/** Correct `inline-block` display not defined in IE 8/9. */
audio, canvas, video { display: inline-block; }

/** Prevent modern browsers from displaying `audio` without controls. Remove excess height in iOS 5 devices. */
audio:not([controls]) { display: none; height: 0; }

/** Address styling not present in IE 8/9. */
[hidden] { display: none; }

/* ========================================================================== Base ========================================================================== */
/** 1. Prevent system color scheme's background color being used in Firefox, IE, and Opera. 2. Prevent system color scheme's text color being used in Firefox, IE, and Opera. 3. Set default font family to sans-serif. 4. Prevent iOS text size adjust after orientation change, without disabling user zoom. */
html { background: #fff; /* 1 */ color: #000; /* 2 */ font-family: sans-serif; /* 3 */ -ms-text-size-adjust: 100%; /* 4 */ -webkit-text-size-adjust: 100%; /* 4 */ }

/** Remove default margin. */
body { margin: 0; }

/* ========================================================================== Links ========================================================================== */
/** Address `outline` inconsistency between Chrome and other browsers. */
a:focus { outline: thin dotted; }

/** Improve readability when focused and also mouse hovered in all browsers. */
a:active, a:hover { outline: 0; }

/* ========================================================================== Typography ========================================================================== */
/** Address variable `h1` font-size and margin within `section` and `article` contexts in Firefox 4+, Safari 5, and Chrome. */
h1 { font-size: 2em; margin: 0.67em 0; }

/** Address styling not present in IE 8/9, Safari 5, and Chrome. */
abbr[title] { border-bottom: 1px dotted; }

/** Address style set to `bolder` in Firefox 4+, Safari 5, and Chrome. */
b, strong { font-weight: bold; }

/** Address styling not present in Safari 5 and Chrome. */
dfn { font-style: italic; }

/** Address differences between Firefox and other browsers. */
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }

/** Address styling not present in IE 8/9. */
mark { background: #ff0; color: #000; }

/** Correct font family set oddly in Safari 5 and Chrome. */
code, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }

/** Improve readability of pre-formatted text in all browsers. */
pre { white-space: pre-wrap; }

/** Set consistent quote types. */
q { quotes: "\201C" "\201D" "\2018" "\2019"; }

/** Address inconsistent and variable font size in all browsers. */
small { font-size: 80%; }

/** Prevent `sub` and `sup` affecting `line-height` in all browsers. */
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }

sup { top: -0.5em; }

sub { bottom: -0.25em; }

/* ========================================================================== Embedded content ========================================================================== */
/** Remove border when inside `a` element in IE 8/9. */
img { border: 0; }

/** Correct overflow displayed oddly in IE 9. */
svg:not(:root) { overflow: hidden; }

/* ========================================================================== Figures ========================================================================== */
/** Address margin not present in IE 8/9 and Safari 5. */
figure { margin: 0; }

/* ========================================================================== Forms ========================================================================== */
/** Define consistent border, margin, and padding. */
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }

/** 1. Correct `color` not being inherited in IE 8/9. 2. Remove padding so people aren't caught out if they zero out fieldsets. */
legend { border: 0; /* 1 */ padding: 0; /* 2 */ }

/** 1. Correct font family not being inherited in all browsers. 2. Correct font size not being inherited in all browsers. 3. Address margins set differently in Firefox 4+, Safari 5, and Chrome. */
button, input, select, textarea { font-family: inherit; /* 1 */ font-size: 100%; /* 2 */ margin: 0; /* 3 */ }

/** Address Firefox 4+ setting `line-height` on `input` using `!important` in the UA stylesheet. */
button, input { line-height: normal; }

/** Address inconsistent `text-transform` inheritance for `button` and `select`. All other form control elements do not inherit `text-transform` values. Correct `button` style inheritance in Chrome, Safari 5+, and IE 8+. Correct `select` style inheritance in Firefox 4+ and Opera. */
button, select { text-transform: none; }

/** 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio` and `video` controls. 2. Correct inability to style clickable `input` types in iOS. 3. Improve usability and consistency of cursor style between image-type `input` and others. */
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; /* 2 */ cursor: pointer; /* 3 */ }

/** Re-set default cursor for disabled elements. */
button[disabled], html input[disabled] { cursor: default; }

/** 1. Address box sizing set to `content-box` in IE 8/9. 2. Remove excess padding in IE 8/9. */
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ }

/** 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome. 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome (include `-moz` to future-proof). */
input[type="search"] { -webkit-appearance: textfield; /* 1 */ -moz-box-sizing: content-box; -webkit-box-sizing: content-box; /* 2 */ box-sizing: content-box; }

/** Remove inner padding and search cancel button in Safari 5 and Chrome on OS X. */
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }

/** Remove inner padding and border in Firefox 4+. */
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }

/** 1. Remove default vertical scrollbar in IE 8/9. 2. Improve readability and alignment in all browsers. */
textarea { overflow: auto; /* 1 */ vertical-align: top; /* 2 */ }

/* ========================================================================== Tables ========================================================================== */
/** Remove most spacing between table cells. */
table { border-collapse: collapse; border-spacing: 0; }

*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }

html, body { font-size: 15px; }

body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; cursor: auto; }

a:hover { cursor: pointer; }

a:focus { outline: none; }

img, object, embed { max-width: 100%; height: auto; }

object, embed { height: 100%; }

img { -ms-interpolation-mode: bicubic; }

#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }

.left { float: left !important; }

.right { float: right !important; }

.text-left { text-align: left !important; }

.text-right { text-align: right !important; }

.text-center { text-align: center !important; }

.text-justify { text-align: justify !important; }

.hide { display: none; }

.antialiased, body { -webkit-font-smoothing: antialiased; }

img { display: inline-block; vertical-align: middle; }

textarea { height: auto; min-height: 50px; }

select { width: 100%; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.23333em; line-height: 1.6; }

.subheader, #content #toctitle, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title, .tableblock > caption { line-height: 1.4; color: #777777; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }

/* Typography resets */
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }

/* Default Link Styles */
a { color: #4183c4; text-decoration: none; line-height: inherit; }
a:hover, a:focus { color: #4183c4; }
a img { border: none; }

/* Default paragraph styles */
p { font-family: helvetica, arial, freesans, clean, sans-serif; font-weight: normal; font-size: 1em; line-height: 1.4; margin-bottom: 1em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.93333em; line-height: 1.35; font-style: italic; }

/* Default header styles */
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: helvetica, arial, freesans, clean, sans-serif; font-weight: bold; font-style: normal; color: #333333; text-rendering: optimizeLegibility; margin-top: 0.2em; margin-bottom: 0.5em; line-height: 1.2em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: gray; line-height: 0; }

h1 { font-size: 1.33333em; }

h2 { font-size: 0.93333em; }

h3, #toctitle, .sidebarblock > .content > .title { font-size: 0.86667em; }

h4 { font-size: 0.66667em; }

h5 { font-size: 1em; }

h6 { font-size: 1em; }

hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.33333em 0 1.26667em; height: 0; }

/* Helpful Typography Defaults */
em, i { font-style: italic; line-height: inherit; }

strong, b { font-weight: bold; line-height: inherit; }

small { font-size: 60%; line-height: inherit; }

code { font-family: Monaco, "DejaVu Sans Mono", "Courier New", monospace; font-weight: normal; color: #666666; }

/* Lists */
ul, ol, dl { font-size: 1em; line-height: 1.4; margin-bottom: 1em; list-style-position: outside; font-family: helvetica, arial, freesans, clean, sans-serif; }

ul, ol { margin-left: 0.7em; }

/* Unordered Lists */
ul li ul, ul li ol { margin-left: 1.33333em; margin-bottom: 0; font-size: 1em; /* Override nested font-size change */ }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }

/* Ordered Lists */
ol li ul, ol li ol { margin-left: 1.33333em; margin-bottom: 0; }

/* Definition Lists */
dl dt { margin-bottom: 0.33333em; font-weight: bold; }
dl dd { margin-bottom: 1.33333em; }

/* Abbreviations */
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #333333; border-bottom: 1px dotted #dddddd; cursor: help; }

abbr { text-transform: none; }

/* Blockquotes */
blockquote { margin: 0 0 1em; padding: 0; border-left: none; }
blockquote cite { display: block; font-size: 0.86667em; color: #666666; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #666666; }

blockquote, blockquote p { line-height: 1.4; color: #666666; }

/* Microformats */
.vcard { display: inline-block; margin: 0 0 1.33333em 0; border: 1px solid #dddddd; padding: 0.66667em 0.8em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 1em; }

.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: auto; text-decoration: none; font-weight: bold; border: none; padding: 0 0.06667em; }

@media only screen and (min-width: 768px) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2em; }
  h2 { font-size: 1.6em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.2em; }
  h4 { font-size: 1em; } }
/* Print styles.  Inlined to avoid required HTTP connection: www.phpied.com/delay-loading-your-print-css/ Credit to Paul Irish and HTML5 Boilerplate (html5boilerplate.com)
*/
.print-only { display: none !important; }

@media print { * { background: transparent !important; color: #000 !important; /* Black prints faster: h5bp.com/s */ box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; /* h5bp.com/t */ }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
/* Tables */
table { background: white; margin-bottom: 1.33333em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.53333em 0.66667em 0.66667em; font-size: 0.93333em; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.6em 0.66667em; font-size: 0.8em; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.4; }

a:hover, a:focus { text-decoration: underline; }

.clearfix:before, .clearfix:after, .float-group:before, .float-group:after { content: " "; display: table; }
.clearfix:after, .float-group:after { clear: both; }

*:not(pre) > code { font-size: 0.86667em; padding: 1px 5px 1px 5px; white-space: nowrap; background-color: transparent; border: 1px solid #dddddd; -webkit-border-radius: 3px; border-radius: 3px; text-shadow: none; }

pre, pre > code { line-height: 1.6; color: white; font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; }

kbd.keyseq { color: #666666; }

kbd:not(.keyseq) { display: inline-block; color: #333333; font-size: 0.8em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }

kbd kbd:first-child { margin-left: 0; }

kbd kbd:last-child { margin-right: 0; }

.menuseq, .menu { color: #1a1a1a; }

#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 66.66667em; *zoom: 1; position: relative; padding-left: 1em; padding-right: 1em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }

#header { margin-bottom: 2.66667em; }
#header > h1 { color: #333333; font-weight: 300; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #666666; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#header br + span.author { padding-left: 0; }
#header br + span.author:before { content: ", "; }

#toc { border-bottom: 0 solid #dddddd; padding-bottom: 1.33333em; }
#toc > ul { margin-left: 0.26667em; }
#toc ul.sectlevel0 > li > a { font-style: italic; }
#toc ul.sectlevel0 ul.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ul { list-style-type: none; }

#toctitle { color: #777777; }

@media only screen and (min-width: 1280px) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #dddddd; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ul { font-size: .95em; }
  #toc.toc2 ul ul { margin-left: 0; padding-left: 1.33333em; }
  #toc.toc2 ul.sectlevel0 ul.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
  body.toc2.toc-right { padding-left: 0; padding-right: 20em; }
  body.toc2.toc-right #toc.toc2 { border-right: 0; border-left: 1px solid #dddddd; left: auto; right: 0; } }
#content #toc { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; border-width: 0; -webkit-border-radius: 3px; border-radius: 3px; }
#content #toc > :first-child { margin-top: 0; }
#content #toc > :last-child { margin-bottom: 0; }
#content #toc a { text-decoration: none; }

#content #toctitle { font-weight: bold; font-family: helvetica, arial, freesans, clean, sans-serif; font-size: 1.06667em; padding-left: 0.13333em; }

#footer { max-width: 100%; background-color: whitesmoke; padding: 1.33333em; }

#footer-text { color: #333333; line-height: 1.26; }

.sect1 { padding-bottom: 1.33333em; }

.sect1 + .sect1 { border-top: 0 solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #333333; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #262626; }

.imageblock, .literalblock, .listingblock, .verseblock, .videoblock { margin-bottom: 1.33333em; }

.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .videoblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .dlist > .title, .olist > .title, .ulist > .title, .qlist > .title, .hdlist > .title { text-align: left; font-weight: bold; }

.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }

table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }

.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.2em; padding-right: 1.33333em; border-left: 1px solid #dddddd; color: #666666; }
.admonitionblock > table td.content > :last-child > :last-child { margin-bottom: 0; }

.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; -webkit-border-radius: 3px; border-radius: 3px; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.66667em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }

.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #eaeaea; box-shadow: 0 1px 8px #eaeaea; }

.sidebarblock { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.33333em; padding: 1.33333em; background: white; -webkit-border-radius: 3px; border-radius: 3px; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.66667em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #777777; margin-top: 0; line-height: 1.4; border-width: 0 0 1px 0; border-style: solid; border-color: #cacaca; }

.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child, .sidebarblock > .content > :last-child > :last-child, .sidebarblock > .content .olist > ol > li:last-child > :last-child, .sidebarblock > .content .ulist > ul > li:last-child > :last-child, .sidebarblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }

.literalblock > .content pre, .listingblock > .content pre { background: #333333; border-width: 2px; border-style: solid; border-color: #dddddd; -webkit-border-radius: 3px; border-radius: 3px; padding: 0.66667em; word-wrap: break-word; }
.literalblock > .content pre.nowrap, .listingblock > .content pre.nowrap { overflow-x: auto; white-space: pre; word-wrap: normal; }
.literalblock > .content pre > code, .listingblock > .content pre > code { display: block; }
@media only screen { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.69333em; } }
@media only screen and (min-width: 768px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.78em; } }
@media only screen and (min-width: 1280px) { .literalblock > .content pre, .listingblock > .content pre { font-size: 0.86667em; } }

.listingblock > .content { position: relative; }

.listingblock:hover code[class*=" language-"]:before { text-transform: uppercase; font-size: 0.9em; color: #999; position: absolute; top: 0.4em; right: 0.4em; }

.listingblock:hover code.asciidoc:before { content: "asciidoc"; }
.listingblock:hover code.clojure:before { content: "clojure"; }
.listingblock:hover code.css:before { content: "css"; }
.listingblock:hover code.groovy:before { content: "groovy"; }
.listingblock:hover code.html:before { content: "html"; }
.listingblock:hover code.java:before { content: "java"; }
.listingblock:hover code.javascript:before { content: "javascript"; }
.listingblock:hover code.python:before { content: "python"; }
.listingblock:hover code.ruby:before { content: "ruby"; }
.listingblock:hover code.scss:before { content: "scss"; }
.listingblock:hover code.xml:before { content: "xml"; }
.listingblock:hover code.yaml:before { content: "yaml"; }

.listingblock.terminal pre .command:before { content: attr(data-prompt); padding-right: 0.5em; color: #999; }

.listingblock.terminal pre .command:not([data-prompt]):before { content: '$'; }

table.pyhltable { border: 0; margin-bottom: 0; }

table.pyhltable td { vertical-align: top; padding-top: 0; padding-bottom: 0; }

table.pyhltable td.code { padding-left: .75em; padding-right: 0; }

.highlight.pygments .lineno, table.pyhltable td:not(.code) { color: #999; padding-left: 0; padding-right: .5em; border-right: 1px solid #dddddd; }

.highlight.pygments .lineno { display: inline-block; margin-right: .25em; }

table.pyhltable .linenodiv { background-color: transparent !important; padding-right: 0 !important; }

.quoteblock { margin: 0 0 1em; padding: 0; border-left: none; }
.quoteblock blockquote { margin: 0 0 1em 0; padding: 0 0 0.6em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.6em; font-size: 0.86667em; color: #666666; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.66667em; }

table thead th, table tfoot th { font-weight: bold; }

table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 3px; border-radius: 3px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }

table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }

table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }

table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }

th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }

th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }

th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }

th.tableblock.valign-top, td.tableblock.valign-top { vertical-align: top; }

th.tableblock.valign-bottom, td.tableblock.valign-bottom { vertical-align: bottom; }

th.tableblock.valign-middle, td.tableblock.valign-middle { vertical-align: middle; }

p.tableblock.header { color: #222222; font-weight: bold; }

td > div.verse { white-space: pre; }

ol { margin-left: 0.96667em; }

ul li ol { margin-left: 0.7em; }

dl dd { margin-left: 1.125em; }

dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }

ol > li p, ul > li p, ul dd, ol dd, .olist .olist, .ulist .ulist, .ulist .olist, .olist .ulist { margin-bottom: 0.5em; }

ul.unstyled, ol.unnumbered, ul.checklist, ul.none { list-style-type: none; }

ul.unstyled, ol.unnumbered, ul.checklist { margin-left: 0.66667em; }

ul.checklist li > p:first-child > i[class^="icon-check"]:first-child, ul.checklist li > p:first-child > input[type="checkbox"]:first-child { margin-right: 0.25em; }

ul.checklist li > p:first-child > input[type="checkbox"]:first-child { position: relative; top: 1px; }

ul.inline { margin: 0 auto 0.5em auto; margin-left: -1.46667em; margin-right: 0; padding: 0; list-style: none; overflow: hidden; }
ul.inline > li { list-style: none; float: left; margin-left: 1.46667em; display: block; }
ul.inline > li > * { display: block; }

.unstyled dl dt { font-weight: normal; font-style: normal; }

ol.arabic { list-style-type: decimal; }

ol.decimal { list-style-type: decimal-leading-zero; }

ol.loweralpha { list-style-type: lower-alpha; }

ol.upperalpha { list-style-type: upper-alpha; }

ol.lowerroman { list-style-type: lower-roman; }

ol.upperroman { list-style-type: upper-roman; }

ol.lowergreek { list-style-type: lower-greek; }

.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }

td.hdlist1 { padding-right: .8em; font-weight: bold; }

td.hdlist1, td.hdlist2 { vertical-align: top; }

.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }

.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.26667em 0; }

.qanda > ol > li > p > em:only-child { color: #3876b4; }

.thumb, .th { line-height: 0; display: inline-block; border: solid 4px white; -webkit-box-shadow: 0 0 0 1px #dddddd; box-shadow: 0 0 0 1px #dddddd; }

.imageblock.left, .imageblock[style*="float: left"] { margin: 0.26667em 0.66667em 1.33333em 0; }
.imageblock.right, .imageblock[style*="float: right"] { margin: 0.26667em 0 1.33333em 0.66667em; }
.imageblock > .title { margin-bottom: 0; }
.imageblock.thumb, .imageblock.th { border-width: 6px; }
.imageblock.thumb > .title, .imageblock.th > .title { padding: 0 0.13333em; }

.image.left, .image.right { margin-top: 0.26667em; margin-bottom: 0.26667em; display: inline-block; line-height: 0; }
.image.left { margin-right: 0.66667em; }
.image.right { margin-left: 0.66667em; }

a.image { text-decoration: none; }

span.footnote, span.footnoteref { vertical-align: super; font-size: 0.93333em; }
span.footnote a, span.footnoteref a { text-decoration: none; }

#footnotes { padding-top: 0.8em; padding-bottom: 0.8em; margin-bottom: 0.66667em; }
#footnotes hr { width: 20%; min-width: 6.66667em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { padding: 0 0.4em; line-height: 1.3; font-size: 0.93333em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a:first-of-type { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }

#content #footnotes { margin-top: -0.66667em; margin-bottom: 0; padding: 0.8em 0; }

.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }

div.unbreakable { page-break-inside: avoid; }

.big { font-size: larger; }

.small { font-size: smaller; }

.underline { text-decoration: underline; }

.overline { text-decoration: overline; }

.line-through { text-decoration: line-through; }

.aqua { color: #00bfbf; }

.aqua-background { background-color: #00fafa; }

.black { color: black; }

.black-background { background-color: black; }

.blue { color: #0000bf; }

.blue-background { background-color: #0000fa; }

.fuchsia { color: #bf00bf; }

.fuchsia-background { background-color: #fa00fa; }

.gray { color: #606060; }

.gray-background { background-color: #7d7d7d; }

.green { color: #006000; }

.green-background { background-color: #007d00; }

.lime { color: #00bf00; }

.lime-background { background-color: #00fa00; }

.maroon { color: #600000; }

.maroon-background { background-color: #7d0000; }

.navy { color: #000060; }

.navy-background { background-color: #00007d; }

.olive { color: #606000; }

.olive-background { background-color: #7d7d00; }

.purple { color: #600060; }

.purple-background { background-color: #7d007d; }

.red { color: #bf0000; }

.red-background { background-color: #fa0000; }

.silver { color: #909090; }

.silver-background { background-color: #bcbcbc; }

.teal { color: #006060; }

.teal-background { background-color: #007d7d; }

.white { color: #bfbfbf; }

.white-background { background-color: #fafafa; }

.yellow { color: #bfbf00; }

.yellow-background { background-color: #fafa00; }

span.icon > [class^="icon-"], span.icon > [class*=" icon-"] { cursor: default; }

.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #4183c4; color: #2e6295; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }

.conum { display: inline-block; color: white !important; background-color: #333333; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum + b { display: none; }
.conum:after { content: attr(data-value); }
.conum:not([data-value]):empty { display: none; }

p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1em; color: #666666; }

h2 { color: #325D72; border-bottom: 1px solid #dddddd; }

#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { color: #333333; }

#header, #content, #footnotes { max-width: 660px; padding-left: 0; padding-right: 0; }

#content ul { list-style-type: none; }
#content ul li { background: url('../images/github/li-chevron.png?1372292342') 0 0.4em no-repeat; padding-left: .7em; }

.olist.procedure > ol { counter-reset: li; list-style: none; position: relative; }
.olist.procedure > ol > li { position: relative; padding: 5px 0 5px 55px; margin-bottom: 5px; }
.olist.procedure > ol > li:before { content: counter(li); counter-increment: li; position: absolute; top: 0; left: 0; height: 100%; width: 30px; padding: 0 10px 0 0; color: #999; font-size: 1.46667em; font-weight: bold; line-height: 1.6; text-align: right; border-right: 1px solid #ddd; }

.quoteblock blockquote { background: url('../images/github/blockquote-arrow.png?1372292342') 0 2px no-repeat; padding-left: 1em; }

.sidebarblock > .content > .title { margin-top: -20px; margin-right: -20px; margin-left: -20px; margin-bottom: 20px; padding: 1em; font-size: 0.8em; background: #eaeaea; }

</style>
</head>
<body class="article">
<div id="header">
<h1>Maidenlane/YCabal Software Design and Specification</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_ycabal">YCabal</a></li>
<li><a href="#_efficiency_by_aggregation">Efficiency by Aggregation</a>
<ul class="sectlevel2">
<li><a href="#_user_capture">User Capture</a></li>
<li><a href="#_service_level_architecture_view">Service Level Architecture View</a></li>
<li><a href="#_aws_deployment">AWS Deployment</a></li>
<li><a href="#_application_security">Application Security</a></li>
</ul>
</li>
<li><a href="#_abriged_requirements_specification">Abriged Requirements Specification</a></li>
<li><a href="#_acknowledgments">Acknowledgments</a></li>
<li><a href="#_about_quality">About quality</a>
<ul class="sectlevel2">
<li><a href="#_the_categories">The categories</a></li>
<li><a href="#_classification_can_be_ambiguous">Classification can be ambiguous</a></li>
<li><a href="#_formulation_of_scenarios">Formulation of scenarios</a></li>
</ul>
</li>
<li><a href="#_approach">Approach</a></li>
<li><a href="#_change_data_capture">Change Data Capture</a>
<ul class="sectlevel3">
<li><a href="#_replaying_write_operations">Replaying Write Operations</a></li>
</ul>
</li>
<li><a href="#_preliminary_implementation">Preliminary Implementation</a></li>
<li><a href="#_other_models_considered">Other Models Considered</a>
<ul class="sectlevel2">
<li><a href="#_higher_level_change_data_capture">Higher Level Change Data Capture</a></li>
<li><a href="#_shared_key_value_store">Shared Key Value Store</a></li>
<li><a href="#_extended_peer_to_peer_model">Extended Peer-To-Peer Model .</a></li>
<li><a href="#_replica_codebase_and_risks_with_geth">Replica Codebase and Risks with Geth</a></li>
</ul>
</li>
<li><a href="#_design_goals">Design Goals</a>
<ul class="sectlevel1">
<li><a href="#_health_checks">Health Checks</a></li>
<li><a href="#_service_initialization">Service Initialization</a></li>
<li><a href="#_load_balancing">Load Balancing</a></li>
<li><a href="#_reduced_computational_requirements">Reduced Computational Requirements</a></li>
</ul>
</li>
<li><a href="#_implementation_and_testing">Implementation and Testing</a>
<ul class="sectlevel1">
<li><a href="#_developer_notice">Developer Notice</a>
<ul class="sectlevel2">
<li><a href="#_overview">Overview</a></li>
<li><a href="#_go_ethereum_requirements">Go Ethereum Requirements</a></li>
<li><a href="#_sendtx">SendTx()</a></li>
</ul>
</li>
<li><a href="#_transaction_emitters">Transaction Emitters</a>
<ul class="sectlevel2">
<li><a href="#_security_considerations">Security Considerations</a></li>
</ul>
</li>
<li><a href="#_operational_requirements">Operational Requirements</a>
<ul class="sectlevel2">
<li><a href="#_developer_notice_2">Developer Notice</a></li>
</ul>
</li>
<li><a href="#_cluster_initialization">Cluster Initialization</a>
<ul class="sectlevel2">
<li><a href="#_master_initialization">Master initialization</a></li>
</ul>
</li>
<li><a href="#_leveldb_snapshotting">LevelDB Snapshotting</a>
<ul class="sectlevel2">
<li><a href="#_replication_master_configuration">Replication Master Configuration</a></li>
</ul>
</li>
<li><a href="#_replica_configuration">Replica Configuration</a>
<ul class="sectlevel2">
<li><a href="#_periodic_replica_snapshots">Periodic Replica Snapshots</a></li>
<li><a href="#_periodic_cluster_refreshes">Periodic Cluster Refreshes</a></li>
<li><a href="#_multiple_clusters">Multiple Clusters</a></li>
<li><a href="#_high_availability">High Availability</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This resource is broken into the two main parts of the solution:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Application and Aggregation layers == YCabal / Backbone Cabal</p>
</li>
<li>
<p>Network and Operational Layers == Maidenlane</p>
<div class="ulist">
<ul>
<li>
<p>YCabal concerns itself with MEV/BEV extraction and other opportunities</p>
</li>
<li>
<p>Maidenlane is the execution and routing platform that strategies such as
YCabal can work on</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ycabal">YCabal</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Monopolizing transaction flow for arbitrage batching with miner support</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This is a strategy that realizes profit by smart transaction batching for the
purposes of arbitrage by controlling transaction ordering.</p>
</div>
<div class="paragraph">
<p>Right now every user sends a transaction directly to the network mempool and
thus give away the arbitrage, front-running, back-running opportunities to
miners(or random bots).</p>
</div>
<div class="paragraph">
<p>YCabal creates a virtualized mempool (i.e. a MEV-relay network) that aggregates
transactions (batching), such transactions include:</p>
</div>
<div class="paragraph">
<p>DEX trades &lt;br&gt;
Interactions with protocols &lt;br&gt;
Auctions &lt;br&gt;
etc &lt;br&gt;</p>
</div>
<div class="literalblock">
<div class="content">
<pre>TL;DR - Users can opt in and send transactions to YCabal and in return for
not having to pay for gas for their transaction we batch process it and take the
arbitrage profit from it. Risk by inventory price risk is carried by a Vault,
where Vault depositers are returned the profit the YCabal realizes</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_efficiency_by_aggregation">Efficiency by Aggregation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By leveraging batching, miner transaction flow, and providing additional
performant utilities (e.g. faster calculations for finalizing),
we can realize the following potential avenues for realizing profitable
activites:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Meta Transaction Funtionality</p>
</li>
<li>
<p>Order trades in different directions sequentially to produce positive slippage</p>
</li>
<li>
<p>Backrun Trades</p>
</li>
<li>
<p>Frontrun Trades</p>
</li>
<li>
<p>At least 21k in the base cost on every transaction is saved</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>If we have access to transactions before the network we can generate value
because we can calculate future state, off-chain, and withold transactions</strong></p>
</div>
</blockquote>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Think of this as creating a Netting Settlement System (whereas blockchains are
a real time gross settlement system)</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_user_capture">User Capture</h3>
<div class="paragraph">
<p>The whole point of Backbone Cabal is to maximize profits from user actions which
gets distributed for free to miners and bots.
We intent to extract this value and provide these profits as <code><strong>cashback</strong></code> to
users.</p>
</div>
<div class="paragraph">
<p><strong>For example</strong>: A SushiSwap trader who loses <code>X%</code> to slippage during his trade
can now get <code>X-Y %</code> slippage on his trade, because we were able to
<strong>both</strong> frontrun <strong>and</strong> backrun their trade and give him the arbitrage profits.</p>
</div>
</div>
<div class="sect2">
<h3 id="_service_level_architecture_view">Service Level Architecture View</h3>
<div class="paragraph">
<p>The financial exchange employs a microservices architecture with independent services interacting with one another to provide a full order management system with a price-time priority orderbook. The figure below shows a high level view of the service level architecture. There are two types of services.</p>
</div>
<div class="paragraph">
<p>Application Services
Infrastructure Services
The application services implement the business logic of the financial exchange while the infrastructure services support the distributed environment under which the application services run and collaborate with one another.</p>
</div>
<div class="paragraph">
<p>![](/images/overview_1.png)</p>
</div>
</div>
<div class="sect2">
<h3 id="_aws_deployment">AWS Deployment</h3>
<div class="paragraph">
<p>Similar to the localhost configuration the application properties for each service is configured with the combination of spring profile named aws and the matching atlas-xxxxx-aws.yml in the configuration git repository where xxxxx is the service name.</p>
</div>
<div class="paragraph">
<p>The AWS deployment architecture is shown in the figure below. Each Application Service and Configuration Service run in a dedicated t2.micro EC2 instance.</p>
</div>
<div class="paragraph">
<p>![](images/AWS.png)</p>
</div>
</div>
<div class="sect2">
<h3 id="_application_security">Application Security</h3>
<div class="paragraph">
<p>There are two parts to application security</p>
</div>
<div class="paragraph">
<p>Data Encryption
User Authentication &amp; Authorization</p>
</div>
<div class="paragraph">
<p>![](images/AWS2.png)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_abriged_requirements_specification">Abriged Requirements Specification</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The remainder of this document is the <code>Abriged Requirements Specification</code></p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_acknowledgments">Acknowledgments</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>KX Systems / First Derivative</p>
</li>
<li>
<p>EtherCattle group</p>
</li>
<li>
<p>Blocknative</p>
</li>
<li>
<p>and many more</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_quality">About quality</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The quality of a product or system is very generally called
<em>Set of properties or characteristics</em> defined.</p>
</div>
<div class="paragraph">
<p>In practice, some categories (generic terms) have been used for frequently occurring <em>quality requirements</em>
(synonymous: quality goals) established, essentially shaped by the conceptual models of DIN / ISO 9126 and 25010.</p>
</div>
<div class="sect2">
<h3 id="_the_categories">The categories</h3>
<div class="ulist">
<ul>
<li>
<p>&lt;&lt; changeability, changeability &gt;&gt;</p>
</li>
<li>
<p>&lt;&lt; usability, usability &gt;&gt;</p>
</li>
<li>
<p>&lt;&lt; efficiency, efficiency &gt;&gt;</p>
</li>
<li>
<p>&lt;&lt; reliability, reliability &gt;&gt;</p>
</li>
<li>
<p>&lt;&lt; operability, operability &gt;&gt;</p>
</li>
<li>
<p>&lt;&lt; other, other (including functionality) &gt;&gt;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_classification_can_be_ambiguous">Classification can be ambiguous</h3>
<div class="paragraph">
<p>Some quality goals or requirements belong to several
"Generic terms" or categories - We try and make clear that
some of them are more <strong>qualitative</strong> in nature.</p>
</div>
<div class="paragraph">
<p>Specific quality requirements are outlined in the appendix.</p>
</div>
</div>
<div class="sect2">
<h3 id="_formulation_of_scenarios">Formulation of scenarios</h3>
<div class="paragraph">
<p>A (quality) scenario describes the behavior (1) of a system (3)
when an event or stimulus occurs (2).</p>
</div>
<div class="sect3">
<h4 id="_1_behavior_of_a_system">(1) Behavior of a system</h4>
<div class="paragraph">
<p>The behavior can relate to software or hardware, or
also refer to the persons, roles or organizations involved.</p>
</div>
<div class="paragraph">
<p>Behavior should always be formulated <em>measurable or decidable</em> in scenarios.</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_event_or_stimulus">(2) Event or stimulus</h4>
<div class="paragraph">
<p>A user initiates a function while working with the system, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>selects a menu item / function</p>
</li>
<li>
<p>clicks a button on a graphical user interface</p>
</li>
<li>
<p>starts processing</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A stakeholder changes something in the system, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>modified source code or configuration of the system</p>
</li>
<li>
<p>changes to the hardware of the system</p>
</li>
<li>
<p>changes the deployment of the system</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A stakeholder changes something in the processes or organizations involved.</p>
</div>
</div>
<div class="sect3">
<h4 id="_3_system">(3) system</h4>
<div class="paragraph">
<p>The term "system" is very broad here: This includes software,
Software components, involved hardware, networks, middleware, databases,
but also all the people, roles or organizations involved.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_approach">Approach</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_change_data_capture">Change Data Capture</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Note This Section Contains Information not made in this document</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>After considering several different approaches to meet our :ref:<code>design-goals</code>, we settled on a Change Data Capture approach (CDC).</p>
</div>
<div class="paragraph">
<p>The idea is to hook into the database interface on one node, capture all write operations, and write them to a transaction log that can be replayed by other nodes.</p>
</div>
<div class="paragraph">
<p>Capturing Write Operations</p>
</div>
<div class="paragraph">
<p>In the Go Ethereum codebase, there is a <code>Database</code> interface which must support the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Put</p>
</li>
<li>
<p>Get</p>
</li>
<li>
<p>NewBatch</p>
</li>
<li>
<p>Has</p>
</li>
<li>
<p>Delete</p>
</li>
<li>
<p>Close</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and a Batch interface which must support the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Put</p>
</li>
<li>
<p>Write</p>
</li>
<li>
<p>Delete</p>
</li>
<li>
<p>Reset</p>
</li>
<li>
<p>ValueSize</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We have created a simple CDC wrapper, which proxies operations to the standard databases supported by Go Ethereum, and records <code>Put</code>, <code>Delete</code>, and <code>Batch.Write</code> operations through a <code>LogProducer</code> interface.
At present, we have implemented a <code>KafkaLogProducer</code> to record write operations to a Kafka topic.</p>
</div>
<div class="paragraph">
<p>The performance impact to the Go Ethereum server is minimal.</p>
</div>
<div class="paragraph">
<p>The CDC wrapper is light weight, proxying requests to the underlying database with minimal overhead.
Writing to the Kafka topic is handled asynchronously, so write operations are unlikely to be delayed substantially due to logging.</p>
</div>
<div class="paragraph">
<p>Read operations will be virtually unaffected by the wrapper.</p>
</div>
<div class="paragraph">
<p>While we have currently implemented a Kafka logger, we have defined an abstract interface that could theoretically support a wide variety of messaging systems.</p>
</div>
<div class="sect3">
<h4 id="_replaying_write_operations">Replaying Write Operations</h4>
<div class="paragraph">
<p>We also have a modified Go Ethereum service which uses a <code>LogConsumer</code> interface to pull logs from Kafka and replay them into a local LevelDB database.
The index of the last written record is also recorded in the database, allowing the service to resume in the event that it is restarted.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_preliminary_implementation">Preliminary Implementation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the current implementation we simply disable peer-to-peer connections on the node and populate the database
via Kafka logs. Other than that it functions as a normal Go Ethereum node.</p>
</div>
<div class="paragraph">
<p>The RPC service in its current state is semi-functional.</p>
</div>
<div class="paragraph">
<p>Many RPC functions default to querying the state trie at the "latest" block.
However, which block is deemed to be the "latest" is normally determined by the peer-to-peer service.
When a new block comes in it is written to the database, but the hash of the latest block is kept in memory.
Without the peer-to-peer service running the service believes that the "latest" block has not updated since the
process initialized and read the block out of the database.</p>
</div>
<div class="paragraph">
<p>If RPC functions are called specifying the target block, instead of implicitly asking for the latest block, it will look for that information in the database and serve it correctly.</p>
</div>
<div class="paragraph">
<p>Despite preliminary successes, there are several potential problems with the current approach.
A normal Go Ethereum node, even one lacking peers, assumes that it is responsible for maintaining its database.
Occasionally this will lead to replicas attempting to upgrade indexes or prune the state trie.
This is problematic because the same operations can be expected to come from the write log of the source node.
Thus we need an approach where we can ensure that the read replicas will make no effort to write to their own database.</p>
</div>
<div class="paragraph">
<p>Proposed Implementation ,</p>
</div>
<div class="paragraph">
<p>Go Ethereum offers a standard <code>Backend</code> interface, which is used by the RPC interface to retrieve the data needed
to offer the standard RPC function calls.
Currently there are two main implementations of the standard Backend interface, one for full Ethereum nodes, and
one for light Ethereum nodes.</p>
</div>
<div class="paragraph">
<p>We propose to write a third implementation for replica Ethereum nodes.</p>
</div>
<div class="paragraph">
<p>We believe we can offer the core functionality required by RPC function calls based entirely on the database state, without needing any of the standard syncing capabilities.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>See <code>TurboGeth: FireHose</code> for more information</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Once that backend is developed, we can launch it as a separate service, which will not attempt to do things like database upgrades, and which will not attempt to establish peer-to-peer connections.</p>
</div>
<div class="paragraph">
<p>Under the hood, it will mostly leverage existing APIs for retrieving information from the database.
This should limit our exposure to changes in the database breaking our code unexpectedly.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_models_considered">Other Models Considered</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section documents several other approaches we considered to achieving our :ref:<code>design-goals</code>.
This is not required reading for understanding subsequent sections, but may help offer some context for the current design.</p>
</div>
<div class="sect2">
<h3 id="_higher_level_change_data_capture">Higher Level Change Data Capture</h3>
<div class="paragraph">
<p>Rather than capturing data as it is written to the database, one option we considered was capturing data as it was written to the State Trie, Blockchain, and Transaction Pool.</p>
</div>
<div class="paragraph">
<p>The advantage of this approach is that the change data capture stream would be reflective of high level operations, and not dependent on low level implementation details regarding how the data gets written to a database.</p>
</div>
<div class="paragraph">
<p>One disadvantage is that it would require more invasive changes to consensus-critical parts of the codebase, creating more room for errors that could effect the network as a whole.
Additionally, because those changes would have been made throughout the Go Ethereum codebase it would be harder to maintain if Go Ethereum does not incorporate our changes.
The proposed implementation requires very few changes to core Go Ethereum codebase, and primarily leverages APIs that should be relatively easy to maintain compatibility with.</p>
</div>
</div>
<div class="sect2">
<h3 id="_shared_key_value_store">Shared Key Value Store</h3>
<div class="paragraph">
<p>Before deciding on a change-data-capture replication system, one option we considered was to use a scalable key value store, which could be written to by one Ethereum node and read by many.
Some early prototypes were developed under this model, but they all had significant performance limitations when it came to validating blocks.
The Ethereum State Trie requires several read operations to retrieve a single piece of information.
These read operations are practical when made against a local disk, but latencies become prohibitively large when the state trie is stored on a networked key value store on a remote system.
This made it infeasible for an Ethereum node to process transactions at the speeds necessary to keep up with the network.</p>
</div>
</div>
<div class="sect2">
<h3 id="_extended_peer_to_peer_model">Extended Peer-To-Peer Model .</h3>
<div class="paragraph">
<p>One option we explored was to add an extended protocol on top of the standard Ethereum peer-to-peer protocol, which would sync the blockchain and state trie from a trusted list of peers without following the rigorous validation procedures.
This would have been a substantially more complex protocol than the one we are proposing, and would have put additional strain on the other nodes in the system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_replica_codebase_and_risks_with_geth">Replica Codebase and Risks with Geth</h3>
<div class="paragraph">
<p>One option we considered was to use Change Data Capture to record change logs, but write a new system from the ground-up to consume the captured information.</p>
</div>
<div class="paragraph">
<p>The biggest problem with this approach, particularly with the low level CDC, is that we would be tightly coupled
to implementation details of how Go Ethereum writes to LevelDB, without having a shared codebase for interpreting
that data.</p>
</div>
<div class="paragraph">
<p>A minor change to how Go Ethereum stores data could break our replicas in subtle ways that might not be caught
until bad data was served in production.</p>
</div>
<div class="paragraph">
<p>If Go Ethereum changes their schema <em>and</em> changes their code to match while maintaining API compatibility, it
should be transparent to the replicas.</p>
</div>
<div class="paragraph">
<p>It is also possible that Go Ethereum changes their APIs in a way that breaks compatibility, but in that case we
should find ourselves unable to compile the replica without fixing the dependency, and shouldn&#8217;t see surprises on
a running system.</p>
</div>
<div class="paragraph">
<p>Finally, by building the replica service in Go as an extension to the existing Go Ethereum codebase, there is a
reasonable chance that we could get the upstream Go Ethereum project to integrate our extensions.
It is very unlikely that they would integrate our read replica extensions if the read replica is a separate
project written in another language.</p>
</div>
</div>
</div>
</div>
<h1 id="_design_goals" class="sect0">Design Goals</h1>
<div class="paragraph">
<p>The primary goal of the Ether Cattle intiative is to provide access to Ethereum
RPC services with minimal operational complexity and cost.
Ideally this will be achieved by enhancing an existing Ethereum client with
capabilities that simplify the operational challenges.</p>
</div>
<div class="sect1">
<h2 id="_health_checks">Health Checks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A major challenge with existing Ethereum nodes is evaluating the health of an
individual node.
Generally nodes should be considered healthy if they have the blockchain and
state trie at the highest block, and are able to serve RPC requests relating to
that state.
If a node is more than a couple of blocks behind the network, it should be
considered unhealthy.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_service_initialization">Service Initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the major challenges with treating Ethereum nodes as disposable is the
initialization time.
Conventionally a new instance must find peers, download the latest blocks from
those peers, and validate each transaction in those blocks.
Even if the instance is built from a relatively recent snapshot, this can be a
bandwidth intensive, computationally intensive, disk intensive, and time
consuming process.</p>
</div>
<div class="paragraph">
<p>In a trustless peer-to-peer system, these steps are unavoidable.
Malicious peers could provide incorrect information, so it is necessary to
validate all of the information received from untrusted peers.
But given several nodes managed by the same operator, it is generally safe for
those nodes to trust eachother, allowing individual nodes to avoid some of the
computationally intensive and disk intensive steps that make the initialization
process time consuming.</p>
</div>
<div class="paragraph">
<p>Ideally node snapshots will be taken periodically, new instances will launch
based on the most recent available snapshot, and then sync the blockchain and
state trie from trusted peers without having to validate every successive
transaction.
Assuming relatively recent snapshots are available, this should allow new
instances to start up in a matter of minutes rather than hours.</p>
</div>
<div class="paragraph">
<p>Additionally, during the initialization process services should be identifiable
as still initializing and excluded from the load balancer pool.
This will avoid nodes serving outdated information during initialization.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_load_balancing">Load Balancing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Given reliable healthchecks and a quick initialization process, one challenge
remains on loadbalancing.
The Ethereum RPC protocol supports a concept of "filter subscriptions" where a
filter is installed on an Ethereum node and subsequent requests about the
subscription are served updates about changes matching the filter since the
previous request.
This requires a stateful session, which depends on having a single Ethereum node
serve each successive request relating to a specific subscription.</p>
</div>
<div class="paragraph">
<p>For now this can be addressed on the client application using <code>Provider
Engine's Filter Subprovider
&lt;https://github.com/MetaMask/provider-engine/blob/master/subproviders/filters.js&gt;</code>
The Filter Subprovider mimics the functionality of installing a filter on a node
and requesting updates about the subscription by making a series of stateless
calls against the RPC server.
Over the long term it might be beneficial to add a shared database that would
allow the load balanced RPC nodes to manage filters on the server side instead
of the client side, but due to the existence of the Filter Subprovider that is
not necessary in the short term.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_reduced_computational_requirements">Reduced Computational Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As discussed in :ref:<code>initialization</code>, a collection of nodes managed by a
single operator do not have the same trust model amongst themselves as nodes in
a fully peer-to-peer system.
RPC Nodes can potentially decrease their computational overhead by relying on a
subset of the nodes within a group to validate transactions.
This would mean that a small portion of nodes would need the computational
capacity to validate every transaction, while the remaining nodes would have
lower resource requirements to serve RPC requests, allowing flexible scaling and
redundancy.</p>
</div>
</div>
</div>
<h1 id="_implementation_and_testing" class="sect0">Implementation and Testing</h1>
<div class="sect1">
<h2 id="_developer_notice">Developer Notice</h2>
<div class="sectionbody">
<div class="paragraph">
<p>!!! note
&gt; Testing Documents are Broken into their relevent sections, this is a general overview
of the Implementation as it relates specifically to the Geth (go-ethereum) client only</p>
</div>
<div class="sect2">
<h3 id="_overview">Overview</h3>
<div class="paragraph">
<p>In <code>go-ethereum/internal/ethapi/backend.go</code>, a Backend interface is specified.
Objects filling this interface can be passed to <code>ethapi.GetAPIs()</code> to return
<code>[]rpc.API</code>, which can be used to serve the Ethereum RPC APIs.
Presently there are two implementations of the Backend interface, one for full
Ethereum nodes and one for Light Ethereum nodes that depend on the LES protocol.</p>
</div>
<div class="paragraph">
<p>This project will implement a third backend implementation, which will provide
the necessary information to ethapi.GetAPIs() to in turn provide the RPC APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_go_ethereum_requirements">Go Ethereum Requirements</h3>
<div class="sect3">
<h4 id="_backend_functions_to_implement">Backend Functions To Implement</h4>
<div class="paragraph">
<p>This section explores each of the 26 methods required by the Backend interface.
This is an initial pass, and attempts to implement these methods may prove more
difficult than described below.</p>
</div>
<div class="paragraph">
<p>Downloader must return a <code><strong>go-ethereum/eth/downloader.Downloader</strong></code> object.</p>
</div>
<div class="paragraph">
<p>Normally the <code>Downloader</code> object is responsible for managing relationships with
remote peers, and synchronizing the block from remote peers.
As our replicas will receive data directly via Kafka, the Downloader object
won&#8217;t see much use.
Even so, the <code>PublicEthereumAPI</code> struct expects to be able to retrieve a
<code>Downloader</code> object so that it can provide the <code>eth_syncing</code> API call.</p>
</div>
<div class="paragraph">
<p>If the Backend interface required an interface for a downloader rather than a
specific Downloader object, we could stub out at Downloader that provided the
<code>eth_syncing</code> data based on the current Kafka sync state.
Unfortunately the Downloader requires a specific object constructed with the
following properties:</p>
</div>
</div>
<div class="sect3">
<h4 id="_mode_syncmode_an_integer_indicating_whether_the_syncmode_is_fast_full_or_light"><code>mode SyncMode</code> - An integer indicating whether the SyncMode is Fast, Full, or Light</h4>

</div>
<div class="sect3">
<h4 id="_statedb_ethdb_database_an_interface_to_leveldb"><code>stateDb ethdb.Database</code> - An interface to LevelDB.</h4>
<div class="paragraph">
<p>Our backend will neeed a Database instance, so this should be easy.</p>
</div>
</div>
<div class="sect3">
<h4 id="_mux_event_typemux_used_only_for_syncing_with_peers"><code>mux <strong>event.TypeMux</strong></code> - Used only for syncing with peers.</h4>
<div class="paragraph">
<p>If we avoid calling Downloader.Synchronize(), it appears this can safely be nil.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chain_blockchain_an_object_providing_the_downloader_blockchain_interface"><code>chain BlockChain</code> - An object providing the downloader.BlockChain interface.</h4>
<div class="paragraph">
<p>If we only need to support Downloader.Progress(), and we set SyncMode to
LightSync, this can be nil.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lightchain_lightchain_an_object_providing_the_downloader_lightchain"><code>lightchain LightChain</code> - An object providing the downloader.LightChain</h4>
<div class="paragraph">
<p>interface.
If we only need to support Downloader.Progress(), and we set SyncMode to
LightSync, we will need to stub this out and provide CurrentHeader() with the
correct blocknumber.
====  <code>dropPeer peerDropFn</code> - Only used when syncing with peers.
If we avoid calling Downloader.Synchronize(), this can be <code>func(string) {}</code></p>
</div>
<div class="paragraph">
<p>Constructing a <code>Downloader</code> with the preceding arguments should provide the
capabilities we need to offer the <code>eth_progress</code> RPC call.</p>
</div>
</div>
<div class="sect3">
<h4 id="_protocolversion">ProtocolVersion()</h4>
<div class="paragraph">
<p>This just needs to return an integer indicating the protocol version.
This tells us what version of the peer-to-peer protocol the Ethereum client is
using.
As replicas will not use a peer-to-peer protocol, it might make sense for this
to be a value like <code>-1</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_suggestprice">SuggestPrice()</h4>
<div class="paragraph">
<p>Should return a <code>big.Int</code> gas price for a transaction.
This can use <code><strong>go-ethereum/eth/gasprice.Oracle</strong></code> to provide the same values a
stanard Ethereum node would provide.
Note, however, that gasprice.Oracle requires a Backend object of its own, so
implementing SuggestPrice() will need to wait until the following backend
methods have been implemented:</p>
</div>
</div>
<div class="sect3">
<h4 id="_headerbynumber"><code>HeaderByNumber()</code></h4>

</div>
<div class="sect3">
<h4 id="_blockbynumber"><code>BlockByNumber()</code></h4>

</div>
<div class="sect3">
<h4 id="_chainconfig"><code>ChainConfig()</code></h4>

</div>
<div class="sect3">
<h4 id="_chaindb">ChainDb().</h4>
<div class="paragraph">
<p>Our backend will need to be constructed with an <code>ethdb.Database</code> object, which
will be it&#8217;s primary source for much of the information about the blockchain and
state.
This method will return that object.</p>
</div>
<div class="paragraph">
<p>For replicas, it might be prudent to have a wrapper that provides the
<code>ethdb.Database</code> interface, but errors on any write operations, as we want to
ensure that all write operations to the primary database come from the
replication process.</p>
</div>
</div>
<div class="sect3">
<h4 id="_eventmux">EventMux()</h4>
<div class="paragraph">
<p>This seem to be used by peer-to-peer systems.
I can&#8217;t find anything in the RPC system that depends on <code>EventMux()</code>, so I think
we can return <code>nil</code> for the Replica backend.</p>
</div>
<div class="paragraph">
<p>AccountManager()</p>
</div>
<div class="paragraph">
<p>This returns an <code><strong>accounts.Manager</strong></code> object, which manages access to Ethereum
wallets and other secret data.
This would be used by the Private Ethereum APIs, which our Replicas will not
implement.
Services that need to manage accounts in conjunction with replica RPC nodes
should utilize client side account managers such as <code>Web3 Provider Engine
&lt;https://www.npmjs.com/package/web3-provider-engine&gt;</code></p>
</div>
<div class="paragraph">
<p>In a future phase we may decide to implement an AccountManager service for
replica nodes, but this would require serious consideration for how to securely
store credentials and share them across the replicas in a cluster.</p>
</div>
<div class="paragraph">
<p>SetHead().</p>
</div>
<div class="paragraph">
<p>This is used by the private debug APIs, allowing developers to set the
blockchain back to an earlier state in private environments.
Replicas should not be able to roll back the blockchain to an earlier state, so
this method should be a no-op.</p>
</div>
<div class="paragraph">
<p>HeaderByNumber()</p>
</div>
<div class="paragraph">
<p>HeaderByNumber needs to return a <code><strong>core/types.Header</strong></code> object corresponding to
the specified block number.
This will need to get information from the database.
It might be possible to leverage in-memory caches to speed up these data
lookups, but it must not rely on information normally provided by the
peer-to-peer protocol manager.</p>
</div>
<div class="paragraph">
<p>This should be able to use <code>core.GetCanonicalHash()</code> to get the blockhash, then
<code>core.GetHeader()</code> to get the Block Number.</p>
</div>
<div class="paragraph">
<p>BlockByNumber()</p>
</div>
<div class="paragraph">
<p>BlockByNumber needs to return a <code><strong>core/types.Block</strong></code> object corresponding to the
specified block number.
This will need to get information from the database.
It might be possible to leverage in-memory caches to speed up these data
lookups, but it must not rely on information normally provided by the
peer-to-peer protocol manager.</p>
</div>
<div class="paragraph">
<p>This should be able to use <code>core.GetCanonicalHash()</code> to get the blockhash, then
<code>core.GetBlock()</code> to get the Block Number.</p>
</div>
<div class="paragraph">
<p>StateAndHeaderByNumber() .</p>
</div>
<div class="paragraph">
<p>Needs to return a <code><strong>core/state.StateDB</strong></code> object and a <code><strong>core/types.Header</strong></code> object
corresponding to the specified block number.</p>
</div>
<div class="paragraph">
<p>The header can be retrieved with <code>backend.HeaderByNumber()</code>.
Then the stateDB object can be created with <code>core/state.New()</code> given the hash
from the retrieved header and the ethdb.Database.</p>
</div>
<div class="paragraph">
<p>GetBlock()</p>
</div>
<div class="paragraph">
<p>Needs to return a <code><strong>core/types.Block</strong></code> given a <code>common.Hash</code>.
This should be able to use <code>core.GetBlockNumber()</code> to get the block number for
the hash, and <code>core.GetBlock()</code> to retrieve the <code><strong>core/types.Block</strong></code>.</p>
</div>
<div class="paragraph">
<p>GetReceipts()</p>
</div>
<div class="paragraph">
<p>Needs to return a <code>core/types.Receipts</code> given a <code>common.Hash</code>.
This should be able to use <code>core.GetBlockNumber()</code> to get the block number for
the hash, and <code>core.GetBlockReceipts()</code> to retrieve the <code>core/types.Receipts</code>.</p>
</div>
<div class="paragraph">
<p>GetTd() .</p>
</div>
<div class="paragraph">
<p>Needs to return a <code><strong>big.Int</code> given a <code>common.Hash</code></strong>.
This should be able to use <code>core.GetBlockNumber()</code> to get the block number for
the hash, and <code>core.GetTd()</code> to retrieve the total difficulty.</p>
</div>
<div class="paragraph">
<p>GetEVM()</p>
</div>
<div class="paragraph">
<p>Needs to return a <code><strong>core/vm.EVM</strong></code>.</p>
</div>
<div class="paragraph">
<p>This requires a <code>core.ChainContext</code> object, which in turn needs to implement:</p>
</div>
</div>
<div class="sect3">
<h4 id="_engine_a_conensus_engine_instance"><code>Engine()</code> - A conensus engine instance.</h4>
<div class="paragraph">
<p>This should reflect the conensus engine of the server the replica is
replicating.
This would be Ethash for Mainnet, but may be Clique or eventually Casper for
other networks.
==== <code>GetHeader()</code> - Can proxy <code>backend.GetHeader()</code></p>
</div>
<div class="paragraph">
<p>Beyond the construction of a new <code>ChainContext</code>, this should be comparable to
the implementation of eth/api_backend.go&#8217;s <code>GetEVM()</code></p>
</div>
</div>
<div class="sect3">
<h4 id="_subscribe_event_apis">Subscribe Event APIs</h4>
<div class="paragraph">
<p>The following methods exist as part of the Event Filtering system.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SubscribeChainEvent()</code></p>
</li>
<li>
<p><code>SubscribeChainHeadEvent()</code></p>
</li>
<li>
<p><code>SubscribeChainSideEvent()</code></p>
</li>
<li>
<p><code>SubscribeTxPreEvent()</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As discussed in :ref:<code>load-balancing</code>, the initial implementation of the
replica service will not support the filtering APIs.
As such, these methods can be no-ops that simply return <code>nil</code>.
In the future we may implement these methods, but it will need to be a
completely new implementation to support filtering on the cluster instead of
individual replicas.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sendtx">SendTx()</h3>
<div class="paragraph">
<p>As replica nodes will not have peer-to-peer connections, they will not be able
to send transactions to the network via conventional methods.
Instead, we propose that the replica will simply queue transactions onto a Kafka
topic.
Independent from the replica service we can have consumers of the transaction
topic emit the transactions to the network using different methods.
The scope of implementing <code>SendTx()</code> is limited to placing the transaction onto
a Kafka topic.
Processing those events and emitting them to the network will be discused in
<code>tx-emitters</code></p>
</div>
<div class="paragraph">
<p>Transaction Pool Methods .</p>
</div>
<div class="paragraph">
<p>The transaction pool in Go Ethereum is kept in memory, rather than in the
LevelDB database.
This means that the primary log stream will not include information about
information about unconfirmed transactions.
Additionally, the primary APIs that would make use of the transaction pool are
the filtering transactions, which we established in :ref:<code>event-apis</code> will not
be supported in the initial implementation.</p>
</div>
<div class="paragraph">
<p>For the first phase, this project will not implement the transaction pool.
In a future phase, depending on demand, we may create a separate log stream for
transaction pool data.
For the first phase, these methods will return as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GetPoolTransactions() - Return an empty <code>types.Transactions</code> slice.</p>
</li>
<li>
<p>GetPoolTransaction() - Return nil</p>
</li>
<li>
<p>GetPoolNonce() - Use <code>statedb.GetNonce</code> to return the most recent confirmed
nonce.</p>
</li>
<li>
<p>Stats() - Return 0 transactions pending, 0 transactions queued</p>
</li>
<li>
<p>TxPoolContent() - Return empty <code>map[common.Address]types.Transactions</code> maps
for both pending and queued transactions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ChainConfig()</p>
</div>
<div class="paragraph">
<p>The ChainConfig property will likely be provided to the Replica Backend as the
backend is contructed, so this will return that value.</p>
</div>
<div class="paragraph">
<p>CurrentBlock()</p>
</div>
<div class="paragraph">
<p>This will need to look up the block hash of the latest block from LevelDB, then
use that to invoke <code>backend.GetBlock()</code> to retrieve the current block.</p>
</div>
<div class="paragraph">
<p>In the future we may be able to optimize this method by keeping the current
block in memory.
If we track when the <code>LatestBlock</code> key in LevelDB gets updated, we can clear the
in-memory cache as updates come in.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transaction_emitters">Transaction Emitters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Emitting transactions to the network is a different challenge than replicating
the chain for reading, and has different security concerns.
As discussed in :ref:<code>send-tx</code>, replica nodes will not have peer-to-peer
connections for the purpose of broadcasting transactions.
Instead, when the <code>SendTx()</code> method is called on our backend, it will log the
transaction to a Kafka topic for a downstream Transaction Emitter to handle.</p>
</div>
<div class="paragraph">
<p>Different use cases may have different needs from transaction emitters.
On one end of the spectrum, OpenRelay needs replicas strictly for watching for
order fills and checking token balances, so no transaction emitters are
necessary in the current workflow.
Other applications may have high volumes of transactions that need to be
emitted.</p>
</div>
<div class="paragraph">
<p>The basic transaction emitter will watch the Kafka topic for transactions, and
make RPC calls to transmit those messages.
This leaves organizations with several options for how to transmit those
messages to the network.
Organizations may choose to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Not to run a transaction emitter at all, if their workflows do not generate
transactions.</p>
</li>
<li>
<p>Run a transaction emitter pointed to the source server that is feeding their
replica nodes.</p>
</li>
<li>
<p>Run a transaction emitter pointed to a public RPC server such as Infura.</p>
</li>
<li>
<p>Run a separate cluster of light nodes for transmitting transactions to the
network</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_security_considerations">Security Considerations</h3>
<div class="paragraph">
<p>The security concerns relating to emitting transactions are different than the
concerns for read operations.
One reason for running a private cluster of RPC nodes is that the RPC protocol
doesn&#8217;t enable publicly hosted nodes to prove the authenticity of the data they
are serving.
To have a trusted source of state data an organization must have trusted
Ethereum nodes.
When it comes to emitting transactions, the peer-to-peer protocol offers roughly
the same assurances that transactions will be emitted to the network as RPC
nodes.
Thus, some organizations may decide to transmit transactions through APIs like
Infura and Etherscan even though they choose not to trust those services for
state data.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operational_requirements">Operational Requirements</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_developer_notice_2">Developer Notice</h3>
<div class="paragraph">
<p>!!! note
&gt; Testing Documents are Broken into their relevent sections, this is a general overview
of the Implementation as it relates specifically to the Geth (go-ethereum) client only</p>
</div>
<div class="paragraph">
<p>The implementation discussed in previous sections relates directly to the software changes required to help operationalize Ethereum clients.
There are also ongoing operational processes that will be required to maintain a cluster of master / replica nodes.</p>
</div>
<div class="paragraph">
<p>{cluster-initialization}</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cluster_initialization">Cluster Initialization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Initializing a cluster comprised of a master and one or more replicas requires a few steps.</p>
</div>
<div class="sect2">
<h3 id="_master_initialization">Master initialization</h3>
<div class="paragraph">
<p>Before standing up any replicas or configuring the master to send logs to Kafka, the master should be synced with the blockchain.
In most circumstances, this should be a typical Geth fast sync with standard garbage collection arguments.</p>
</div>
<div class="paragraph">
<p>{_leveldb-snapshots}</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_leveldb_snapshotting">LevelDB Snapshotting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once the master is synced, the LevelDB directory needs to be snapshotted.
This will become the basis of both the subsequent master and the replica servers.</p>
</div>
<div class="sect2">
<h3 id="_replication_master_configuration">Replication Master Configuration</h3>
<div class="paragraph">
<p>Once synced and ready for replication, the master needs to be started with the garbage collection mode of "archive".
Without the "archive" garbage collection mode, the state trie is kept in memory, and not written to either LevelDB or Kafka immediately.
If state data is not written to Kafka immediately, the replicas have only the chain data and cannot do state lookups.
The master should also be configured with a Kafka broker and topic for logging write operations.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_replica_configuration">Replica Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Replicas should be created with a copy of the LevelDB database snapshotted in :ref:<code>leveldb-snapshots</code>.
When executed, the replica service should be pointed to the same Kafka broker and topic as the master.
Any changes written by the master since the LevelDB snapshot will be pulled from Kafka before the Replica starts serving HTTP requests.</p>
</div>
<div class="sect2">
<h3 id="_periodic_replica_snapshots">Periodic Replica Snapshots</h3>
<div class="paragraph">
<p>When new replicas are scaled up, they will connect to Kafka to pull any changes not currently reflected in their local database.
The software manages this by storing the Kafka offset of each write operation as it persists to LevelDB, and when a new replica starts up it will replay any write operations more recent than the offset of the last saved operation.
However this assumes that Kafka will have the data to resume from that offset, and in practice Kafka periodically discards old data.
Without intervention, a new replica will eventually spin up to find that Kafka no longer has the data required for it to resume.</p>
</div>
<div class="paragraph">
<p>The solution for this is fairly simple.
We need to snapshot the replicas more frequently than Kafka fully cycles out data.
Each snapshot should reflect the latest data in Kafka at the time the snapshot was taken, and any new replicas created from that snapshot will be able to resume so long as Kafka still has the offset from the time the snapshot was taken.</p>
</div>
<div class="paragraph">
<p>The mechanisms for taking snapshots will depend on operational infrastructure.
The implementation will vary between cloud providers or on-premises infrastructure management tools, and will be up to each team to implement (though we may provide additional documentation and tooling for specific providers).</p>
</div>
<div class="paragraph">
<p>Administrators should be aware of Kafka&#8217;s retention period, and be sure that snapshots are taken more frequently than the retention period, leaving enough time to troubleshoot failed snapshots before Kafka runs out</p>
</div>
</div>
<div class="sect2">
<h3 id="_periodic_cluster_refreshes">Periodic Cluster Refreshes</h3>
<div class="paragraph">
<p>Because replication requires the master to write to LevelDB with a garbage collection mode of "archive", the disk usage for each node of a cluster can grow fairly significantly after the initial sync.
When disk usage begins to become a problem, the entire cluster can be refreshed following the :ref:<code>cluster-initialization</code> process.</p>
</div>
<div class="paragraph">
<p>Both clusters can run concurrently while the second cluster is brought up, but it is important that the two clusters use separate LevelDB snapshots and separate Kafka partitions to stay in sync (they can use the same Kafka broker, if it is capable of handling the traffic).</p>
</div>
<div class="paragraph">
<p>As replicas for the new cluster are spun up, they will only start serving HTTP requests once they are synced with their respective Kafka partition.
Assuming your load balancer only attempts to route requests to a service once it has passed health checks, both clusters can co-exist behind the load balancer concurrently.</p>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_clusters">Multiple Clusters</h3>
<div class="paragraph">
<p>Just as multiple clusters can co-exist during a refresh, multiple clusters can co-exist for stability purposes.
Within a single cluster, the master server is a single point of failure.
If the master gets disconnected from its peers or fails for other reasons, its peers will not get updates and become stale.
A new master can be created from the last LevelDB snapshot, but that will take time during which the replicas will be stale.</p>
</div>
<div class="paragraph">
<p>With multiple clusters, when a master is determined to be unhealthy its replicas could be removed from the load balancer to avoid stale data, and additional clusters could continue to serve current data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_high_availability">High Availability</h3>
<div class="paragraph">
<p>A single cluster provides several operational benefits over running conventional Ethereum nodes, but the master server is still a single point of failure.
Using data stored in Kafka, the master can recover much more quickly than a node that needed to sync from peers, but that can still lead to a period of time where the replicas are serving stale data.</p>
</div>
<div class="paragraph">
<p>To achieve high availability requires multiple clusters with independent masters and their own replicas.
Multiple replica clusters can share a high-availability Kafka cluster.
The following formula can be used to determine the statistical availability of a cluster:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">math</dt>
<dd>
<p>a = 1 - (1 - \frac{mtbf}{mttr + mtbf})^N</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mtbf</code> - Mean Time Between Failures - The average amount of time between failures of a master server</p>
</li>
<li>
<p><code>mttr</code> - Mean Time To Recovery - The average amount of time it takes to replace a master server after a failure</p>
</li>
<li>
<p><code>N</code> - The number of independently operating clusters</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The values of <code>mtbf</code> and <code>mttr</code> will depend on your operational environment.
With our AWS CloudFormation templates, we have established an <code>mttr</code> of 45 minutes when snapshotting daily.
We have not gathered enough data to establish a mtbf, but with two independent clusters and a 45 minute <code>mttr</code>, EC2&#8217;s regional SLA becomes the bounding factor of availability if the <code>mtbf</code> is greater than two weeks.</p>
</div>
<div class="paragraph">
<p>This formula focuses only on the availability of masters - it assumes that each master has multiple independent replicas.
If a master only has a single replica, that will hurt the <code>mtbf</code> of the cluster as a whole.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-01-18 05:46:12 -0800
</div>
</div>
</body>
</html>